create database customer_bahavior;
use customer_bahavior;

select * from customer_shopping_behavior limit 20;

-- Q1. What is the total revenue generated by male vs. female customers?
select 
	gender, sum(purchase_amount) as revenue 
from customer_shopping_behavior 
group by gender;

-- Q2. Which customers used a discount but still spend more than average purchase amount?
SELECT 
	customer_id, purchase_amount
FROM customer_shopping_behavior
WHERE discount_applied = 'Yes'
  AND purchase_amount > (SELECT AVG(purchase_amount) FROM customer_shopping_behavior);

-- Q3. What are the top 5 products with the highest average review rating?
select  
	item_purchased, round(avg(review_rating), 2) as "Average Product Rating"
from customer_shopping_behavior 
group by item_purchased
order by avg(review_rating) desc
limit 5;

-- Q4. Compare the average Purchase Amounts between Standard and Express shipping.
select 
	shipping_type,
	ROUND(AVG(purchase_amount), 2) as "Average Purchase Amount"
from customer_shopping_behavior 
where shipping_type in ('Express', 'Standard')
group by shipping_type;

-- Q5. Do subscribed customers spend more? Compare average spend and total revenus between subscribers and non-subscribers.
 select 
		subscription_status,
        count(customer_id) as total_customers,
		ROUND(AVG(purchase_amount), 2) as "Average_Spend", 
        ROUND(SUM(purchase_amount), 2) as "Total_Revenue" 
from customer_shopping_behavior 
where subscription_status in ('Yes', 'No')
group by subscription_status
order by Total_Revenue asc, Average_Spend desc; 

-- Q6. Which 5 products have the highest percentage of purchases with discounts applied?
select 
		item_purchased,
        round(100 * SUM(case when discount_applied = "Yes" then 1 End) / Count(*) , 2) as discount_rate
from customer_shopping_behavior
group by item_purchased
order by discount_rate desc
limit 5;

-- Q7. Segment customers into New, Returning, and Loyal based on their total number of previous purchases, and show the count of each segment.
with customer_type as (
	select  previous_purchases,
    case
		when previous_purchases = 1 Then "New"
        when previous_purchases Between 2 and 10 Then "Returning"
        else "Loyal"
        end as customer_segment
	from customer_shopping_behavior
)

select 
	customer_segment, count(*) as "Number of Customers"
from customer_type
group by customer_segment;

-- Q8. What are the top 3 most purchased products within each category?
with item_counts as (
    select category,
    item_purchased,
    COUNT(customer_id )  as total_orders,
    ROW_NUMBER() over(partition by category order by count(customer_id) DESC) as item_rank 
    from customer_shopping_behavior
    group by category, item_purchased
)

select *
from item_counts
where item_rank <= 3;

-- Q9. Are customers who are repeat buyers (more than 5 previous purchases ) also likely to subscribe?
select 
	subscription_status,
    count(customer_id) as repeat_buyers
from customer_shopping_behavior 
where previous_purchases > 5
group by subscription_status;


-- Q10. What is the revenue contribution of each age group?
select
	age_group,
	sum(purchase_amount) as revenue_contributed
from customer_shopping_behavior
group by age_group
order by revenue_contributed desc;
